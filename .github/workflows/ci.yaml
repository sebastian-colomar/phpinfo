################################################################################
#      Copyright (C) 2020        Sebastian Francisco Colomar Bauza             #
#      SPDX-License-Identifier:  GPL-2.0-only                                  #
################################################################################
name: CI                                                                       #
on:                                                                            #
  push:                                                                        #
    branches:                                                                  #
    - 2022-01                                                                  #
jobs:                                                                          #
  docker:                                                                      #
    runs-on: ubuntu-18.04                                                      #
    steps:                                                                     #
    - name: checkout                                                           #
      uses: actions/checkout@v2                                                #
    - name: build                                                              #
      run: docker build -f Dockerfile -t phpinfo:2022-01 .                     ;
    - name: run                                                                #
      run:                                                                     >
        docker run -d --entrypoint php --name phpinfo -p 8080:8080             \
          -v $PWD/src/index.php:/src/index.php:ro -w /src/ phpinfo:2022-01     \
          -f index.php -S 0.0.0.0:8080                                         ;
    - name: test                                                               #
      run:                                                                     |
        while true                                                             ;
          do                                                                   \
            sleep 10                                                           ;
            curl localhost:8080 | grep "PHP.*phpinfo()" && break               ;
          done                                                                 ;
                                                                               #
  swarm:                                                                       #
    runs-on: ubuntu-18.04                                                      #
    steps:                                                                     #
    - name: checkout                                                           #
      uses: actions/checkout@v2                                                #
    - name: build                                                              #
      run: docker build -f Dockerfile -t phpinfo:2022-01 .                     ;
    - name: init                                                               #
      run: docker swarm init                                                   ;
    - name: role                                                               #
      run: sed -i /node.role/s/worker/manager/ docker-compose.yaml             ;
    - name: deploy                                                             #
      run: docker stack deploy -c docker-compose.yaml phpinfo                  ;
    - name: test                                                               #
      run:                                                                     |
        while true                                                             ;
          do                                                                   \
            sleep 10                                                           ;
            ip=$( ip r | grep -v docker | awk '/kernel/{ print $9 }' )         ;
            curl ${ip}:8080 | grep "PHP.*phpinfo()" && break                   ;
          done                                                                 ;
                                                                               #
  kubernetes:                                                                  #
    env:                                                                       #
      mode: kubernetes                                                         #
    runs-on: ubuntu-18.04                                                      #
    steps:                                                                     #
    - name: checkout                                                           #
      uses: actions/checkout@v2                                                #
    - name: build                                                              #
      run: docker build -t phpinfo:2022-01 .                                   ;
    - name: init                                                               #
      run:                                                                     |
        set -x                                                                 ;
        uuid=$( md5sum kube-compose.yaml | cut -d\  -f1 )                      ;
        git clone --single-branch -b v1.2                                      \
          https://github.com/academiaonline/kubernetes $uuid                   ;
        path=$uuid/bin/cluster/ubuntu18/install-docker-kubelet.sh              ;
        source $path                                                           ;
        path=$uuid/bin/cluster/ubuntu18/install-leader.sh                      ;
        source $path                                                           ;
        master=$( kubectl get node | grep master | awk '{ print $1 }' )        ;
        kubectl taint node $master node-role.kubernetes.io/master:NoSchedule-  ;
        rm -rf $uuid                                                           ;
    - name: apply                                                              #
      run: kubectl apply -f kube-compose.yaml                                  ;
    - name: test                                                               #
      run:                                                                     |
        set -x                                                                 ;
        while true                                                             ;
          do                                                                   \
            sleep 10                                                           ;
            kubectl logs rc/phpinfo-rc 2>& 1 | grep "PHP" && break             ;
          done                                                                 ;
################################################################################
